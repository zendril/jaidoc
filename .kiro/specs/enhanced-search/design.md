# Enhanced Search Design Document

## Overview

The enhanced search system will replace the current title-only search with a comprehensive full-text search that indexes multiple content types from documentation pages. The system will maintain the existing Fuse.js fuzzy search library while expanding the search index structure and implementing a modern, keyboard-navigable results interface.

## Architecture

### Current System Analysis
- **Location**: Search functionality is generated by `src/jaidoc/jaidoc_html.jai` during HTML generation
- **Search Library**: Fuse.js (already included at `src/jaidoc/assets/js/fuse.min.js`)
- **Index Format**: Simple JSON array with `url` and `title` fields generated in `jaidoc_html.jai`
- **Search Scope**: Page titles only
- **UI**: Basic text links with `<br>` separators
- **Interaction**: Mouse-only clicking
- **Index Generation**: Both `search-index.json` and `search.js` are generated by Jai code during HTML generation
- **Note**: There's also a `build-search-index.js` file that appears to be unused or for a different purpose

### Enhanced System Architecture
- **Search Library**: Continue using Fuse.js with expanded configuration
- **Index Format**: Enhanced JSON structure with multiple searchable fields
- **Search Scope**: Titles, headers, procedures, variables, unions, and content snippets
- **UI**: Styled dropdown with structured result items
- **Interaction**: Full keyboard navigation + mouse support

## Components and Interfaces

### 1. Enhanced Search Index Structure

```javascript
// New search index format
[
  {
    "url": "module_SampleModule.html",
    "title": "Module: SampleModule",
    "type": "page",
    "content": "SampleModule procedures variables unions",
    "items": [
      {
        "id": "procedure_speak_poetry_10",
        "name": "speak_poetry",
        "type": "procedure",
        "context": "speak_poetry :: ()",
        "anchor": "#procedure_speak_poetry_10"
      },
      {
        "id": "variable_module_status_code_3", 
        "name": "module_status_code",
        "type": "variable",
        "context": "module_status_code: int = 200;",
        "anchor": "#variable_module_status_code_3"
      }
    ]
  }
]
```

### 2. Search Configuration

```javascript
// Enhanced Fuse.js configuration
const fuseOptions = {
  keys: [
    { name: 'title', weight: 0.4 },
    { name: 'content', weight: 0.2 },
    { name: 'items.name', weight: 0.3 },
    { name: 'items.context', weight: 0.1 }
  ],
  includeScore: true,
  includeMatches: true,
  threshold: 0.4,
  minMatchCharLength: 2
};
```

### 3. Search Results UI Component

```html
<!-- Enhanced search results structure -->
<div id="search-results" class="search-results-container">
  <div class="search-result-item" data-url="..." data-anchor="...">
    <div class="result-title">Module: SampleModule</div>
    <div class="result-type">Procedure</div>
    <div class="result-context">speak_poetry :: ()</div>
  </div>
</div>
```

### 4. Keyboard Navigation Manager

```javascript
class SearchNavigationManager {
  constructor(resultsContainer, searchInput) {
    this.container = resultsContainer;
    this.input = searchInput;
    this.currentIndex = -1;
    this.results = [];
  }
  
  handleKeyDown(event) {
    // Handle arrow keys, enter, escape
  }
  
  highlightResult(index) {
    // Visual highlighting logic
  }
  
  selectResult() {
    // Navigation logic
  }
}
```

## Data Models

### SearchIndex Model
```typescript
interface SearchIndexItem {
  url: string;
  title: string;
  type: 'page' | 'module' | 'file';
  content: string;
  items: SearchableItem[];
}

interface SearchableItem {
  id: string;
  name: string;
  type: 'procedure' | 'variable' | 'union' | 'header';
  context: string;
  anchor: string;
}
```

### SearchResult Model
```typescript
interface SearchResult {
  item: SearchIndexItem | SearchableItem;
  score: number;
  matches: FuseMatch[];
  displayTitle: string;
  displayType: string;
  displayContext: string;
  url: string;
  anchor?: string;
}
```

## Error Handling

### Search Index Loading
- **Fallback**: If enhanced index fails to load, fall back to current simple index
- **Error Display**: Show "Search temporarily unavailable" message
- **Retry Logic**: Attempt to reload index after 5 seconds

### Search Execution
- **Empty Query**: Hide results container
- **No Results**: Display styled "No results found" message
- **Search Errors**: Log errors and show fallback message

### Navigation Errors
- **Invalid URLs**: Validate URLs before navigation
- **Missing Anchors**: Navigate to page top if anchor doesn't exist
- **Keyboard Event Errors**: Gracefully handle event binding failures

## Testing Strategy

### Unit Tests
1. **Search Index Processing**
   - Test index loading and parsing
   - Test search result ranking and scoring
   - Test result formatting and display data preparation

2. **Keyboard Navigation**
   - Test arrow key navigation through results
   - Test enter key selection
   - Test escape key behavior
   - Test focus wrapping at boundaries

3. **Search Functionality**
   - Test various search queries against different content types
   - Test fuzzy matching behavior
   - Test result limiting and pagination

### Integration Tests
1. **End-to-End Search Flow**
   - Type query → see results → navigate with keyboard → select result
   - Type query → see results → click with mouse → navigate to page
   - Test search across different page types (modules, files, index)

2. **UI Interaction Tests**
   - Test responsive behavior of results container
   - Test scrolling behavior with many results
   - Test visual states (hover, focus, selected)

### Manual Testing Scenarios
1. **Content Coverage Testing**
   - Search for procedure names from sample module
   - Search for variable names
   - Search for header text
   - Search for partial matches and typos

2. **Accessibility Testing**
   - Test keyboard-only navigation
   - Test screen reader compatibility
   - Test focus management and visual indicators

## Implementation Phases

### Phase 1: Enhanced Search Index
- Modify index generation to include full content
- Update search.js to handle new index structure
- Maintain backward compatibility with current index

### Phase 2: Improved Search Logic
- Implement multi-field search with Fuse.js
- Add result ranking and relevance scoring
- Add result type detection and formatting

### Phase 3: Enhanced UI
- Create styled search results container
- Implement structured result item display
- Add loading and error states

### Phase 4: Keyboard Navigation
- Implement arrow key navigation
- Add enter/escape key handling
- Add focus management and visual highlighting

### Phase 5: Mouse Integration
- Add hover states and click handlers
- Ensure keyboard/mouse interaction compatibility
- Add click-outside-to-close behavior